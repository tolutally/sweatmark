rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // STRICT AUTHENTICATION - NO ANONYMOUS USERS
    // Each user can only access their own data
    // ============================================
    
    // Helper function to check if user is authenticated (non-anonymous)
    function isAuthenticatedUser() {
      return request.auth != null 
        && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticatedUser() && request.auth.uid == userId;
    }
    
    // ============================================
    // USER DATA (workouts, profile, custom exercises)
    // ============================================
    match /users/{userId} {
      // Allow read/write only if the user is authenticated (non-anonymous) and accessing their own data
      allow read, write: if isOwner(userId);
      
      // User profile subcollection
      match /profile/{document=**} {
        allow read, write: if isOwner(userId);
      }
      
      // User workouts subcollection
      match /workouts/{workoutId} {
        allow read, write: if isOwner(userId);
      }
      
      // User custom exercises subcollection
      match /custom_exercises/{exerciseId} {
        allow read, write: if isOwner(userId);
      }
      
      // User schedule subcollection
      match /schedule/{document=**} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ============================================
    // WORKOUT TEMPLATES
    // ============================================
    match /templates/{templateId} {
      // Allow read if user owns the template (non-anonymous)
      allow read: if isAuthenticatedUser() && resource.data.userId == request.auth.uid;
      
      // Allow create if user is authenticated (non-anonymous) and setting themselves as owner
      allow create: if isAuthenticatedUser() && request.resource.data.userId == request.auth.uid;
      
      // Allow update/delete if user owns the template
      allow update, delete: if isAuthenticatedUser() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // TEMPLATE COLLECTIONS (folders)
    // ============================================
    match /template_collections/{collectionId} {
      // Allow read if user owns the collection (non-anonymous)
      allow read: if isAuthenticatedUser() && resource.data.userId == request.auth.uid;
      
      // Allow create if user is authenticated (non-anonymous) and setting themselves as owner
      allow create: if isAuthenticatedUser() && request.resource.data.userId == request.auth.uid;
      
      // Allow update/delete if user owns the collection
      allow update, delete: if isAuthenticatedUser() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // DENY ALL OTHER ACCESS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
